# セキュリティガイドライン

## セキュリティに関する注意事項

### ログファイル

ログファイル（`logs/`ディレクトリ）には以下の情報が記録されます：
- インストール手順
- システム情報（macOSバージョン、アーキテクチャ）
- ファイルパス
- エラーメッセージ

**推奨事項**:
- ログファイルを公開リポジトリにコミットしない（.gitignoreで除外済み）
- 定期的に古いログを削除（設定で`KEEP_LOGS_DAYS`を調整）

### 状態ファイル

状態ファイル（`state/setup-state.json`）には以下が含まれます：
- ユーザー名
- インストールパス
- システム情報

**推奨事項**:
- 状態ファイルを共有しない（.gitignoreで除外済み）
- 環境固有の情報が含まれるため、個人で管理

### sudoの使用

スクリプトは以下の操作でsudoを要求します：
- Xcodeライセンスの承認
- Xcode設定の変更
- 一部のシステムツールのインストール

**セキュリティ対策**:
- スクリプト自体はrootで実行しない（`ensure_not_root`関数で確認）
- 必要な箇所でのみsudoを使用
- ユーザーに明示的に確認を求める

### 外部ソースからのダウンロード

以下の公式ソースからダウンロードします：
- Homebrew: `https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh`
- Flutter: `https://github.com/flutter/flutter.git`

**セキュリティ対策**:
- すべてHTTPSを使用
- 公式リポジトリのみ使用
- `git clone --depth 1`で最小限のダウンロード

### 設定ファイル

`config/config.sh`には環境設定が含まれます。

**注意事項**:
- このファイルは.gitignoreで除外済み
- 機密情報（パスワードなど）は含まない設計
- パスやプロジェクト名のみ

### ファイルパーミッション

**現在の実装**:
- デフォルトのumaskでファイルを作成
- スクリプトは実行権限が必要（`chmod +x setup.sh`）

**推奨事項**:
ログと状態ファイルのパーミッションを制限したい場合：
```bash
# ログディレクトリを自分だけ読み書き可能に
chmod 700 logs/

# 状態ディレクトリを自分だけ読み書き可能に
chmod 700 state/
```

### Apple ID / 開発者アカウント

スクリプトは**Apple IDやパスワードを扱いません**。

- Xcodeで手動でApple IDを追加
- スクリプトはアカウント情報に触れない
- コード署名はXcodeが管理

### 潜在的なリスク

#### 1. シェルインジェクション

**リスク**: ユーザー入力が適切に検証されない場合

**対策済み**:
- ユーザー入力は限定的（y/nの確認のみ）
- ファイルパスは適切に引用符で囲んでいる
- `eval`の使用は最小限（Homebrew設定のみ）

#### 2. パストラバーサル

**リスク**: 相対パスの悪用

**対策済み**:
- 絶対パスを使用（`SCRIPT_DIR`）
- ユーザーが指定するパスは設定ファイル内のみ

#### 3. 権限昇格

**リスク**: sudo経由での不正な操作

**対策済み**:
- rootでの実行を禁止
- sudoは必要最小限の箇所のみ
- ユーザーに明示的に確認

## 脆弱性の報告

セキュリティ上の問題を発見した場合：

1. **公開Issueを作成しないでください**
2. 代わりに以下の方法で報告：
   - プロジェクトメンテナに直接連絡
   - 詳細な情報を含める：
     - 問題の説明
     - 再現手順
     - 影響範囲
     - 可能であれば修正案

## ベストプラクティス

### ユーザー向け

1. **信頼できるソースから入手**
   - 公式リポジトリからclone
   - ダウンロードしたスクリプトを実行前に確認

2. **スクリプトを確認**
   ```bash
   # スクリプトの内容を確認
   cat setup.sh
   less setup.sh
   ```

3. **テスト環境で試す**
   - 可能であれば仮想環境で先にテスト
   - 本番環境の前に動作確認

4. **ログを定期的に削除**
   ```bash
   # 30日以上前のログを削除
   find logs/ -name "*.log" -mtime +30 -delete
   ```

5. **機密情報を含めない**
   - config/config.shにパスワードなどを記載しない
   - カスタムスクリプトを追加する場合も同様に注意

### 開発者向け

1. **コードレビュー**
   - 変更前にセキュリティ影響を評価
   - 外部入力は常に検証

2. **最小権限の原則**
   - sudoは必要最小限
   - ファイルパーミッションを適切に設定

3. **依存関係の管理**
   - 公式ソースのみ使用
   - HTTPSで通信

4. **ログ記録**
   - 機密情報をログに記録しない
   - デバッグ情報は注意して扱う

## 更新履歴

- 2026-01-09: 初版作成
