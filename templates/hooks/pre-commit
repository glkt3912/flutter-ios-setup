#!/bin/bash
# Pre-commit hook for Flutter projects
# Automatically formats Dart code and runs static analysis before commits
#
# This hook is installed by flutter-ios-setup
# To bypass this hook temporarily, use: git commit --no-verify

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if this is a Flutter project
if [ ! -f "pubspec.yaml" ]; then
    # Not a Flutter project, skip hook
    exit 0
fi

echo -e "${BLUE}ðŸ” Running pre-commit checks...${NC}"
echo ""

# Get staged Dart files
DART_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.dart$')

if [ -z "$DART_FILES" ]; then
    echo -e "${GREEN}âœ“ No Dart files to check${NC}"
    exit 0
fi

# Count files
FILE_COUNT=$(echo "$DART_FILES" | wc -l | tr -d ' ')
echo -e "${YELLOW}Found $FILE_COUNT Dart file(s) to check${NC}"
echo ""

# ============================================================================
# Step 1: Format Dart code
# ============================================================================

echo -e "${BLUE}ðŸ“ Formatting Dart code...${NC}"

# Create a temporary file to track if any files were formatted
FORMATTED=0

for file in $DART_FILES; do
    # Check if file still exists (it might have been deleted)
    if [ -f "$file" ]; then
        # Format the file
        dart format "$file" > /dev/null 2>&1

        # Check if file was modified by formatter
        if git diff --name-only "$file" | grep -q "$file"; then
            echo -e "  ${YELLOW}â†’ Formatted: $file${NC}"
            FORMATTED=1
            # Re-stage the formatted file
            git add "$file"
        fi
    fi
done

if [ $FORMATTED -eq 0 ]; then
    echo -e "  ${GREEN}âœ“ All files already formatted${NC}"
else
    echo -e "  ${GREEN}âœ“ Code formatting complete${NC}"
fi

echo ""

# ============================================================================
# Step 2: Run static analysis
# ============================================================================

echo -e "${BLUE}ðŸ”Ž Running static analysis...${NC}"

# Run flutter analyze without pub get (faster)
if flutter analyze --no-pub 2>&1 | tee /tmp/flutter_analyze_output.txt; then
    echo -e "${GREEN}âœ“ Static analysis passed${NC}"
    rm -f /tmp/flutter_analyze_output.txt
else
    echo ""
    echo -e "${RED}âœ— Static analysis found issues${NC}"
    echo -e "${YELLOW}Please fix the issues above before committing.${NC}"
    echo ""
    echo -e "${YELLOW}Tip: Run 'flutter analyze' to see all issues${NC}"
    echo -e "${YELLOW}Tip: To commit anyway, use: git commit --no-verify${NC}"

    rm -f /tmp/flutter_analyze_output.txt
    exit 1
fi

echo ""
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo ""

exit 0
